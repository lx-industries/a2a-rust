# Rust-specific CI configuration

# File patterns that trigger Rust jobs
.rust-changes: &rust-changes
  - "Cargo.toml"
  - "Cargo.lock"
  - "crates/**/*"
  - "tests/**/*"
  - ".cargo/**/*"
  - ".gitlab/ci/rust.gitlab-ci.yml"

# Cargo registry cache (pull-only for dependencies)
.cargo-registry-cache: &cargo-registry-cache
  key: $CI_COMMIT_REF_SLUG
  paths:
    - ".cargo/.crates.toml"
    - ".cargo/.crates2.json"
    - ".cargo/bin/"
    - ".cargo/registry/index/"
    - ".cargo/registry/cache/"
    - ".cargo/registry/src/"
    - ".cargo/git/db/"
  policy: pull

# Base template for all Rust jobs
.rust-template:
  # Docker Hub convention: variant goes in tag, not image name (like python:3.12-slim, node:20-alpine)
  image: registry.gitlab.com/lx-industries/a2a-rust/images/rust:1.92.0-x86_64-unknown-linux-gnu@sha256:df85fd517be782ee7fc1cd27d7a792276a1b46b4e619738a4b9e845bd14ca3a6
  variables:
    CARGO_HOME: ".cargo"
    RUSTC_WRAPPER: sccache
    GIT_FETCH_EXTRA_FLAGS: "+refs/heads/main:refs/remotes/origin/main"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes: *rust-changes
    - if: "$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH"
      changes: *rust-changes
    - if: "$CI_COMMIT_TAG"
  before_script:
    - rustc --version
    - cargo --version
    - sccache --version || true
  cache:
    - <<: *cargo-registry-cache
  interruptible: true

# Build jobs
build:x86_64-unknown-linux-gnu:
  extends: .rust-template
  stage: build
  script:
    - cargo build --all-features --verbose
    - sccache --show-stats || true

build:wasm32-wasip2:
  extends: .rust-template
  # Docker Hub convention: variant goes in tag, not image name
  image: registry.gitlab.com/lx-industries/a2a-rust/images/rust:1.92.0-wasm32-wasip2@sha256:286eee78770a8dcb0b2e43a958a4a3e88ff54eb1e718df03b59d4834fc235283
  stage: build
  script:
    - cargo build -p a2a-transport-wasi -p a2a-wasm-component --target wasm32-wasip2 --release --verbose
    - sccache --show-stats || true
  artifacts:
    paths:
      - target/wasm32-wasip2/release/a2a_wasm_component.wasm
    expire_in: 1 day

# Test jobs
cargo-test:
  extends: .rust-template
  stage: test
  script:
    - cargo test --all-features --verbose
    - sccache --show-stats || true
  needs:
    - build:x86_64-unknown-linux-gnu

cargo-doc-test:
  extends: .rust-template
  stage: test
  script:
    - cargo test --doc --all-features
    - sccache --show-stats || true
  needs:
    - build:x86_64-unknown-linux-gnu

test:wasm-integration:
  stage: test
  image: rust:1.92.0
  needs:
    - build:wasm32-wasip2
  before_script:
    # Install uv for Python
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - source $HOME/.local/bin/env
  script:
    # Run all tests for the WASM component (WASM binary from build job artifact)
    - cargo test -p a2a-wasm-component
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes: *rust-changes
    - if: "$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH"
      changes: *rust-changes
    - if: "$CI_COMMIT_TAG"
  interruptible: true

# Lint jobs
cargo-clippy:
  extends: .rust-template
  stage: check
  before_script:
    - !reference [.rust-template, before_script]
    - cargo clippy --version
  script:
    - cargo clippy --all-targets --all-features -- -D warnings
    - sccache --show-stats || true

cargo-fmt:
  extends: .rust-template
  stage: check
  before_script:
    - !reference [.rust-template, before_script]
    - cargo fmt --version
  script:
    - cargo fmt --all -- --check

# Docs job
cargo-doc:
  extends: .rust-template
  stage: docs
  script:
    - cargo doc --all-features --no-deps
    - sccache --show-stats || true
  needs:
    - build:x86_64-unknown-linux-gnu
  artifacts:
    paths:
      - target/doc
    expire_in: 1 week
