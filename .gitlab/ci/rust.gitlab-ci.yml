# Rust-specific CI configuration

# File patterns that trigger Rust jobs
.rust-changes: &rust-changes
  - "Cargo.toml"
  - "Cargo.lock"
  - "crates/**/*"
  - "tests/**/*"
  - ".cargo/**/*"
  - ".gitlab/ci/rust.gitlab-ci.yml"

# Cargo registry cache (pull-only for dependencies)
.cargo-registry-cache: &cargo-registry-cache
  key: $CI_COMMIT_REF_SLUG
  paths:
    - ".cargo/.crates.toml"
    - ".cargo/.crates2.json"
    - ".cargo/bin/"
    - ".cargo/registry/index/"
    - ".cargo/registry/cache/"
    - ".cargo/registry/src/"
    - ".cargo/git/db/"
  policy: pull

# Base template for all Rust jobs
.rust-template:
  image: registry.gitlab.com/lx-industries/a2a-rust/rust/x86_64-unknown-linux-gnu:1.92.0@sha256:a933303684495cce4cf74380ad1ffc4cfa38f14a014b5405d09f136e497f08ef
  variables:
    CARGO_HOME: ".cargo"
    RUSTC_WRAPPER: sccache
    GIT_FETCH_EXTRA_FLAGS: "+refs/heads/main:refs/remotes/origin/main"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes: *rust-changes
    - if: "$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH"
      changes: *rust-changes
    - if: "$CI_COMMIT_TAG"
  before_script:
    - rustc --version
    - cargo --version
    - sccache --version || true
  cache:
    - <<: *cargo-registry-cache
  interruptible: true

# Build jobs
build:x86_64-unknown-linux-gnu:
  extends: .rust-template
  stage: build
  script:
    - cargo build --all-features --verbose
    - sccache --show-stats || true

build:wasm32-wasip2:
  extends: .rust-template
  image: registry.gitlab.com/lx-industries/a2a-rust/rust/wasm32-wasip2:1.92.0@sha256:5056a36708818371ac2ed1c6874d89c4b2e52ce1ec0852b9f0cbb261abca1e8d
  stage: build
  script:
    - cargo build -p a2a-transport-wasi -p a2a-wasm-component --target wasm32-wasip2 --verbose
    - sccache --show-stats || true

# Test jobs
cargo-test:
  extends: .rust-template
  stage: test
  script:
    - cargo test --all-features --verbose
    - sccache --show-stats || true
  needs:
    - build:x86_64-unknown-linux-gnu

cargo-doc-test:
  extends: .rust-template
  stage: test
  script:
    - cargo test --doc --all-features
    - sccache --show-stats || true
  needs:
    - build:x86_64-unknown-linux-gnu

test:wasm-integration:
  stage: test
  image: rust:1.92.0
  variables:
    WASM_TARGET: wasm32-wasip2
  before_script:
    # Install uv for Python
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - source $HOME/.local/bin/env
    # Install WASM target
    - rustup target add wasm32-wasip2
  script:
    # Build the WASM component first
    - cargo build -p a2a-wasm-component --target wasm32-wasip2 --release
    # Run integration tests (spawns Python server internally)
    - cargo test -p a2a-wasm-component --test integration_test -- --test-threads=1
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  interruptible: true

# Lint jobs
cargo-clippy:
  extends: .rust-template
  stage: check
  before_script:
    - !reference [.rust-template, before_script]
    - cargo clippy --version
  script:
    - cargo clippy --all-targets --all-features -- -D warnings
    - sccache --show-stats || true

cargo-fmt:
  extends: .rust-template
  stage: check
  before_script:
    - !reference [.rust-template, before_script]
    - cargo fmt --version
  script:
    - cargo fmt --all -- --check

# Docs job
cargo-doc:
  extends: .rust-template
  stage: docs
  script:
    - cargo doc --all-features --no-deps
    - sccache --show-stats || true
  needs:
    - build:x86_64-unknown-linux-gnu
  artifacts:
    paths:
      - target/doc
    expire_in: 1 week
