// crates/a2a-wasm-component/wit/a2a.wit
package a2a:protocol@0.2.0;

// TODO: Add json-value variant for metadata support
// variant json-value {
//     null,
//     bool(bool),
//     number(f64),
//     str(string),
//     array(list<json-value>),
//     object(list<tuple<string, json-value>>),
// }

interface types {
    /// Message sender role
    enum role {
        user,
        agent,
    }

    /// Task lifecycle state (A2A TaskState)
    enum task-state {
        submitted,
        working,
        input-required,
        completed,
        canceled,
        failed,
        rejected,
        auth-required,
        unknown,
    }

    /// Text content part
    record text-part {
        text: string,
        // TODO: metadata: option<list<tuple<string, json-value>>>,
    }

    /// File content reference or inline data
    record file-content {
        name: option<string>,
        mime-type: option<string>,
        uri: option<string>,
        bytes: option<list<u8>>,
    }

    /// File content part
    record file-part {
        file: file-content,
        // TODO: metadata: option<list<tuple<string, json-value>>>,
    }

    /// Structured data part (JSON)
    record data-part {
        data: string,
        mime-type: option<string>,
        // TODO: metadata: option<list<tuple<string, json-value>>>,
    }

    /// Content part within a message or artifact
    variant part {
        text(text-part),
        file(file-part),
        data(data-part),
    }

    /// A2A protocol message
    record message {
        role: role,
        parts: list<part>,
        message-id: option<string>,
        task-id: option<string>,
        context-id: option<string>,
        // TODO: reference-task-ids: option<list<string>>,
        // TODO: extensions: option<list<string>>,
        // TODO: metadata: option<list<tuple<string, json-value>>>,
    }

    /// Task output artifact
    record artifact {
        artifact-id: string,
        name: option<string>,
        description: option<string>,
        parts: list<part>,
        // TODO: extensions: option<list<string>>,
        // TODO: metadata: option<list<tuple<string, json-value>>>,
    }

    /// Task status with state and optional details
    record task-status {
        state: task-state,
        message: option<message>,
        timestamp: option<string>,
    }

    /// A2A task
    record task {
        id: string,
        context-id: string,
        status: task-status,
        history: option<list<message>>,
        artifacts: option<list<artifact>>,
        // TODO: metadata: option<list<tuple<string, json-value>>>,
    }

    /// Configuration for message/send
    record message-send-config {
        accepted-output-modes: option<list<string>>,
        history-length: option<u32>,
        blocking: option<bool>,
        // TODO: push-notification-config
    }

    /// Parameters for message/send
    record message-send-params {
        message: message,
        configuration: option<message-send-config>,
        // TODO: metadata: option<list<tuple<string, json-value>>>,
    }

    /// Response from message/send
    variant send-response {
        task(task),
        message(message),
    }

    /// JSON-RPC error
    record error {
        code: s32,
        message: string,
        // TODO: data: option<json-value>,
    }
}

/// Client interface for calling other A2A agents (outgoing requests)
interface client {
    use types.{task, message-send-params, send-response, error};

    /// Send a message to an A2A agent (JSON-RPC: message/send)
    send-message: func(
        agent-url: string,
        params: message-send-params
    ) -> result<send-response, error>;

    /// Get a task by resource name (JSON-RPC: tasks/get)
    /// name: Resource name in format "tasks/{task_id}"
    get-task: func(
        agent-url: string,
        name: string,
        history-length: option<u32>
    ) -> result<option<task>, error>;

    /// Cancel a task by resource name (JSON-RPC: tasks/cancel)
    /// name: Resource name in format "tasks/{task_id}"
    cancel-task: func(
        agent-url: string,
        name: string
    ) -> result<option<task>, error>;
}

/// Server interface for handling incoming A2A requests (as an agent)
/// Note: This interface is kept for documentation but no longer exported.
/// The component now exports wasi:http/incoming-handler instead.
interface server {
    use types.{task, message-send-params, send-response, error};

    /// Handle incoming message/send request
    /// tenant: Optional tenant identifier for multi-tenancy
    on-message: func(tenant: option<string>, params: message-send-params) -> result<send-response, error>;

    /// Handle incoming tasks/get request
    /// tenant: Optional tenant identifier for multi-tenancy
    /// name: Resource name in format "tasks/{task_id}"
    on-get-task: func(tenant: option<string>, name: string, history-length: option<u32>) -> result<option<task>, error>;

    /// Handle incoming tasks/cancel request
    /// tenant: Optional tenant identifier for multi-tenancy
    /// name: Resource name in format "tasks/{task_id}"
    on-cancel-task: func(tenant: option<string>, name: string) -> result<option<task>, error>;
}

/// Agent interface imported from host - provides actual agent logic
interface agent {
    use types.{task, message-send-params, send-response, error};

    /// Get agent card as JSON string
    /// tenant: Optional tenant identifier for multi-tenancy
    get-agent-card: func(tenant: option<string>) -> result<string, error>;

    /// Process incoming message (blocking)
    /// tenant: Optional tenant identifier for multi-tenancy
    on-message: func(tenant: option<string>, params: message-send-params) -> result<send-response, error>;

    /// Retrieve task by resource name
    /// tenant: Optional tenant identifier for multi-tenancy
    /// name: Resource name in format "tasks/{task_id}"
    on-get-task: func(tenant: option<string>, name: string, history-length: option<u32>) -> result<option<task>, error>;

    /// Handle task cancellation
    /// tenant: Optional tenant identifier for multi-tenancy
    /// name: Resource name in format "tasks/{task_id}"
    on-cancel-task: func(tenant: option<string>, name: string) -> result<option<task>, error>;
}

world a2a-component {
    import wasi:http/outgoing-handler@0.2.3;
    import agent;

    export wasi:http/incoming-handler@0.2.3;
    export client;
}
